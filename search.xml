<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>C/C++动态链接库的简单使用</title>
      <link href="/posts/e9447a0f/"/>
      <url>/posts/e9447a0f/</url>
      
        <content type="html"><![CDATA[<h1 id="C语言下最简单的动态链接库demo"><a href="#C语言下最简单的动态链接库demo" class="headerlink" title="C语言下最简单的动态链接库demo"></a>C语言下最简单的动态链接库demo</h1><p>实现一个demo，在main.c中调用动态链接库中的add函数。</p><h2 id="准备源码"><a href="#准备源码" class="headerlink" title="准备源码"></a>准备源码</h2><p>首先实现add函数，在add.c中实现以下内容。</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>在add.h中实现以下内容。</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> ADD_H_</span><span class="token macro property">#<span class="token directive keyword">define</span> ADD_H_</span><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">/* MAX_H_ */</span></code></pre><p>在main.c中包含头文件并调用函数。</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"add.h"</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Sum of %d and %d is %d\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="编译运行"><a href="#编译运行" class="headerlink" title="编译运行"></a>编译运行</h2><ol><li><p>编译动态链接库。</p><pre class=" language-bash"><code class="language-bash">gcc --shared -fPIC -o libadd.so add.c</code></pre></li></ol><ol start="2"><li><p>编译主函数</p><pre class=" language-bash"><code class="language-bash">gcc -o main main.c -L. -ladd</code></pre></li></ol><ol start="3"><li><p>运行。</p><pre class=" language-bash"><code class="language-bash">$ ./mainSum of 10 and 20 is 30</code></pre></li></ol><h1 id="C语言实现的动态链接库在C-中调用"><a href="#C语言实现的动态链接库在C-中调用" class="headerlink" title="C语言实现的动态链接库在C++中调用"></a>C语言实现的动态链接库在C++中调用</h1><p>如果直接使用</p><pre class=" language-c++"><code class="language-c++">#include<iostream>#include "add.h"int main(){    int a = 10, b = 20;    printf("Sum of %d and %d is %d\n", a, b, add(a, b));    std::cout << "Sum of " << a << " and " << b << " is " << add(a, b) << "\n";    return 0;}</code></pre><p>编译</p><pre class=" language-bash"><code class="language-bash">$ g++ -o main2 main2.cpp -L. -ladd/usr/bin/ld: /tmp/cc0fInkR.o: <span class="token keyword">in</span> <span class="token keyword">function</span> `main<span class="token string">':main2.cpp:(.text+0x26): undefined reference to `add(int, int)'</span>/usr/bin/ld: main2.cpp:<span class="token punctuation">(</span>.text+0xa4<span class="token punctuation">)</span>: undefined reference to `add<span class="token punctuation">(</span>int, int<span class="token punctuation">)</span>'collect2: error: ld returned 1 <span class="token keyword">exit</span> status</code></pre><p>需要为头文件add.h做更改</p><pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> ADD_H_</span><span class="token macro property">#<span class="token directive keyword">define</span> ADD_H_</span><span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span><span class="token keyword">extern</span> <span class="token string">"C"</span>  <span class="token comment" spellcheck="true">//C++</span><span class="token punctuation">{</span><span class="token macro property">#<span class="token directive keyword">endif</span></span>   <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span><span class="token punctuation">}</span><span class="token macro property">#<span class="token directive keyword">endif</span></span><span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment" spellcheck="true">/* MAX_H_ */</span></code></pre><p>再重新编译动态链接库，再编译就可以。</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># rui @ rdma221 in ~/nfs/code/cc_code_test/dynamic_dll [12:38:49] C:1</span>$ gcc --shared -fPIC -o libadd.so add.c<span class="token comment" spellcheck="true"># rui @ rdma221 in ~/nfs/code/cc_code_test/dynamic_dll [12:40:35]</span>$ g++ -o main2 main2.cpp -L. -ladd<span class="token comment" spellcheck="true"># rui @ rdma221 in ~/nfs/code/cc_code_test/dynamic_dll [12:40:37]</span>$ ./main2Sum of 10 and 20 is 30Sum of 10 and 20 is 30</code></pre><h1 id="动态连接库更改时不重新编译主程序？"><a href="#动态连接库更改时不重新编译主程序？" class="headerlink" title="动态连接库更改时不重新编译主程序？"></a>动态连接库更改时不重新编译主程序？</h1><p>更改动态链接库内容如下</p><pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>重新编译动态链接库但是不编译主程序，查看运行结果。</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># rui @ rdma221 in ~/nfs/code/cc_code_test/dynamic_dll [12:41:00]</span>$ gcc --shared -fPIC -o libadd.so add.c<span class="token comment" spellcheck="true"># rui @ rdma221 in ~/nfs/code/cc_code_test/dynamic_dll [12:43:18]</span>$ ./main2Sum of 10 and 20 is 60Sum of 10 and 20 is 60</code></pre><p>说明在更改动态库时不需要重新编译主程序也能够生效。</p><p>如果是静态库呢？</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
